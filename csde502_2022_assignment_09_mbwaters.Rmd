---
title: "CSDE 502 Winter 2021, Assignment 9"
author: "mbwaters"
output: 
    bookdown::html_document2:
        number_sections: true
        self_contained: true
        code_folding: hide
        toc: true
        toc_float:
            collapsed: true
            smooth_scroll: false
    pdf_document:
        number_sections: true
        toc: true
        fig_cap: yes
        keep_tex: yes
urlcolor: blue 
---

<!-- This is a CSS style sheet for the answers -->
<style>
h1 {
  font-size: 22px;}
  
h2 {
  font-size: 18px;}
  
h3 {
  font-size: 18px;}

p {
  font-size: 16px;}

.answer {
  font-size: 18px;
  background-color: lightblue;
  border: 2px solid red;
  border-radius: 12px;
  padding: 5px;  
  } 
  
.indent {
  background-color: lightblue;
  padding-left: 50px;
  
  } 
}
</style>

```{r}
library(captioner)

figure_nums <- captioner(prefix = "Figure")
table_nums <- captioner(prefix = "Table")

# path to this file name
if (!interactive()) {
    fnamepath <- knitr::current_input(dir = TRUE)
} else {
    fnamepath <- ""
}
```

```{r}
library(captioner)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(haven)

figure_nums <- captioner(prefix = "Figure")
table_nums <- captioner(prefix = "Table")

# path to this file name
if (!interactive()) {
    fnamepath <- knitr::current_input(dir = TRUE)
} else {
    fnamepath <- ""
}
```

***Explanation***:
This assignment is intended to give you more practice delving into the Add Health data set and in manipulating additional variables. 

***Instructions***: 

1. Make sure your Rmd file has no local file system dependencies (i.e., anyone should be able to recreate the output HTML using only the Rmd source file).
1. Make a copy of this Rmd file and add answers below each question. The code that generated the answers should be included, as well as the complete source code for the document.\    
Put your answers within the **$\lt$div class="answer"$\gt$...$\lt$/div$\gt$** tags so they will show up within the blue boxes with red borders.
1. Change the YAML header above to identify yourself and include contact information.
1. For any tables or figures, include captions and cross-references and any other document automation methods as necessary.
1. Make sure your output HTML file looks appealing to the reader.
1. Upload the final Rmd to your github repository.
1. Download [`assn_id.txt`](http://staff.washington.edu/phurvitz/csde502_winter_2021/assignments/assn_id.txt) and include the URL to your Rmd file on github.com.
1. Create a zip file from your copy of `assn_id.txt` and upload the zip file to the Canvas site for Assignment 1. ***The zip file should contain only the text file. Do not include any additional files in the zip file--everything should be able to run from the file you uploaded to github.com. Please use zip format and not 7z or any other compression/archive format.***


#
**Using the full household roster (you'll need to go back the full raw data source, [21600-0001-Data.dta](http://staff.washington.edu/phurvitz/csde502_winter_2021/data/21600-0001-Data.dta.zip)), create the following variables for each respondent. Document any decisions that you make regarding missing values, definitions, etc. in your narrative as well as in the R code.  Include a frequency tabulation and a histogram of each result.**



##
**Total number in household**

The code below creates a column showing the total number of household members. Each variable with the pattern $H1HR2.*$ indicates an additional household member. A value of "7" indicates that the respondent lives alone, but all other values indicate the presence of another member and are recoded to 1. 

<div class="answer">
```{r}
# download data
myUrl <- "http://staff.washington.edu/phurvitz/csde502_winter_2021/data/21600-0001-Data.dta.zip"
# zipfile in temp
tmpdir <- dirname(tempdir())
zipfname <- file.path(tmpdir, basename(myUrl))
dtafname <- tools::file_path_sans_ext(zipfname) %>% basename()
# check if the zip file exists, download if necessary
if (!file.exists(zipfname)) {
    curl::curl_download(url = myUrl, destfile = zipfname)
}

# if the data set has not been read, read it in
if (!exists("x")) {
    x <- read_dta(unz(description = zipfname, filename = dtafname))
}
# lowercase column names
colnames(x) %<>% str_to_lower()

# get only "h1hr*"
h1hr <- select(x, matches("h1hr.*"))

# get only h1hr2.*
h1hr2 <- x %>%
    select(matches("^h1hr2[[:alpha:]]+$"))

# recode all such that a 7 means no other household members, otherwise the value represents a person
h1hr2_n <- h1hr2 %>%
    mutate_all(
        list(
            ~case_when(
                . == 7 ~ 0,
                TRUE ~ 1
            )
        )
    ) %>% 
    data.frame() %>% 
    mutate(total = 1 + rowSums(., na.rm = TRUE))

xt <- h1hr2_n %>% 
    group_by(total) %>% 
    summarise(frequency = n()) 
```

```{r}
xt %>% 
    kable(caption = "Count of household members") %>% 
    kable_styling(full_width = FALSE, position = "left")
```

```{r fig.cap="Histogram of number of household members (ggplot2::geom_histogram())"}
# histogram with ggplot2
ggplot(data = h1hr2_n, mapping = aes(x = total)) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(breaks = 1:max(xt$total),
                       labels = 1:max(xt$total)) +
    xlab("Total household members") + 
    theme_bw()
```

```{r}
# recode all such that a 7 means no other household members, otherwise the value represents a person
h1hr2_n <- h1hr2 %>%
    mutate_all(
        list(
            ~case_when(
                . > 5 ~ 0,
                TRUE ~ 1
            )
        )
    ) %>% 
    data.frame() %>% 
    mutate(total = 1 + rowSums(., na.rm = TRUE))

xt <- h1hr2_n %>% 
    group_by(total) %>% 
    summarise(frequency = n())

xt %>% 
    kable(caption = "Count of household members (6 and 8 coded as zero)") %>% 
    kable_styling(full_width = FALSE, position = "left")
```

```{r fig.cap="Histogram of count of household members (6 and 8 coded as zero)"}
# histogram with ggplot
ggplot(data = xt, mapping = aes(x = total, y = frequency)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = 1:max(xt$total),
                       labels = 1:max(xt$total)) +
    xlab("total in household") +
    theme_bw()
```
</div>

##
**Number of sisters**

For the variables including $h1hr3.*$, "8" indicates that the household member was a sister, so this was recoded to 1 while all other values were recoded to zero (including "refused" and "don't know").

<div class="answer">
```{r}
# get H1HR3* variables
h1hr3 <- x %>% 
    select(matches("^h1hr3[[:alpha:]]+$")) 

# recode 8 (sister) = 1, else 0
h1hr3_sister <- h1hr3 %>%
    mutate_all(
        list(
            ~case_when(
                . == 8 ~ 1,
                TRUE ~ 0
            )
        )
    ) %>% 
    mutate(total = rowSums(.))

xt <- h1hr3_sister %>% 
    group_by(total) %>% 
    summarise(frequency = n())

xt %>% 
    kable(caption = "Count of sisters") %>% 
    kable_styling(full_width = FALSE, position = "left")
```

```{r fig.cap="Histogram of number of sisters"}
# histogram with ggplot
ggplot(data = xt, mapping = aes(x = total, y = frequency)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = 1:max(xt$total),
                       labels = 1:max(xt$total)) +
    xlab("Total number of sisters")+
    theme_bw()
```

</div>

##
**Number of brothers**

<div class="answer">
For the variables including $h1hr3.*$, "5" indicates that the household member was a brother, so this was recoded to 1 while all other values were recoded to zero (including "refused" and "don't know").

```{r}
# get H1HR3* variables
h1hr3 <- x %>% 
    select(matches("^h1hr3[[:alpha:]]+$"))
# recode: 5 (brother) = 1, else 0
h1hr3_brother <- h1hr3 %>%
    mutate_all(
        list(
            ~case_when(
                . == 5 ~ 1,
                TRUE ~ 0
            )
        )
    ) %>% 
    data.frame()  %>%
    mutate(total = rowSums(.))
xt <- h1hr3_brother %>% 
    group_by(total) %>% 
    summarise(frequency = n())
xt %>% 
    kable(caption = "Count of brothers") %>% 
    kable_styling(full_width = FALSE, position = "left")
```

```{r fig.cap="Histogram of count of brothers"}
# histogram with ggplot2
ggplot(data = xt, mapping = aes(x = total, y = frequency)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = 1:max(xt$total),
                       labels = 1:max(xt$total)) +
    xlab("Total number of brothers")+
    theme_bw()
```
</div>

##
**Total number of siblings**

<div class="answer">
The code below combines the data generated in the two previous sections.
```{r}
# combine previous data
sibling_count <- h1hr3_brother %>% 
    select(brother = total) %>% 
    mutate(sister = h1hr3_sister$total,
           total = brother + sister)

xt <- sibling_count %>% 
    group_by(total) %>% 
    summarise(frequency = n())

xt %>% 
    kable(caption = "Count of siblings") %>% 
    kable_styling(full_width = FALSE, position = "left")
```
</div>

#
**What proportion of students live with two biological parents? Include the analysis in your R code.**

<div class="answer">
Columns including the pattern $h1hr6.*$ include information about parents in the household. A value of "1" indicates biological father and a value of "7"indicates biological mother. Both of these values were recoded to 1 and all other values were recoded to zero.
```{r}
# get H1HR6* variables
h1hr6 <- x %>% 
    select(matches("^h1hr6[[:alpha:]]+$"))

# recode
# if H1HR6 = 1 or 7 then biological parent
h1hr6_bioparent <- h1hr6 %>%
    mutate_all(
        list(
            ~ case_when(
                . %in% c(1, 7) ~ 1,
                TRUE ~ 0
            )
        )
    ) %>%
    mutate(total = rowSums(.)) %>% 
    mutate(`lives with 2 biological parents` = total==2)

# how many with 2 biological parents?
bioparent_sum <- h1hr6_bioparent %>%
    group_by(`lives with 2 biological parents`) %>% 
    summarise(frequency = n()) %>%      
    mutate(`%` = (frequency / sum(frequency) * 100) %>% round(1))

bioparent_sum %>% 
    kable(caption = "Respondents living with two biological parents") %>% 
    kable_styling(full_width = FALSE, position = "left")
```
</div>
#
**Calculate the number of household members that are NOT biological mother, biological father, full brother or full sister. Create a contingency table and histogram for this variable.**

<div class="answer">
The columns with the patterns $h1hr3.*$, $h1hr5.*$, and $h1hr6.*$ were used. A value of "97" for $h1hr3.*$ indicates that the participant lives alone, so this was recoded to zero with all other responses recoded to 1. Summing the rows provides the total number of household members with 1 added to include the participant. 

```{r}
# variables for siblings and parents
h1hr_biosib_bioparent <- x %>% 
    select(
        matches("h1hr3[[:alpha:]]+$|^h1hr5[[:alpha:]]+$|^h1hr6[[:alpha:]]+$")
    )

# recode h1hr3 any to zero if 97 (lives alone), otherwise 1 as another person
# recode h1hr5 to 1 if 1 (full brother), 7 (full sister) to zero, otherwise 0
# recode h1hr6 to 1 if 1 (biological father), 7 (biological mother), otherwise 0
# rowSums of h1hr5 and h1hr6 would give total full brother/sister/ bio mother/father

h1hr_biosib_bioparent_calc <- h1hr_biosib_bioparent %>%
    # to count all persons
    mutate_at(
        .vars = vars(matches("h1hr3")),
        list(
            ~case_when(
                . == 97 ~ 0,
                TRUE ~ 1
            )
        )
    ) %>% 
# to count full brother/sister and biological mother/father
    mutate_at(
        .vars = vars(matches("h1hr5|h1hr6")),
        list(
            ~ case_when(
                . %in% c(1, 7) ~ 1,
                # any other person don't count in this group
                TRUE ~ 0
            )
        )
    ) %>%
    mutate(total_persons = 1 + rowSums(select(., matches("h1hr3"))),
           total_fullsib_bioparent = rowSums(select(., matches("h1hr5|h1hr6"))),
           total_not_fullsib_bioparent = total_persons - total_fullsib_bioparent)

# tabulate
xt <- h1hr_biosib_bioparent_calc %>% 
    group_by(total_not_fullsib_bioparent) %>% 
    summarise(frequency = n())

xt %>% 
    kable(caption = "Count of household members who are not biological parents or full siblings") %>% 
    kable_styling(full_width = FALSE, position = "left")
```

```{r}
# histogram
ggplot(data = xt, mapping = aes(x = total_not_fullsib_bioparent , y = frequency)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = 0:max(xt$total_not_fullsib_bioparent ),
                       labels = 0:max(xt$total_not_fullsib_bioparent )) +
    xlab("Number not biological parents or full siblings")+
    theme_bw()
```
</div>

<hr>
Rendered at <tt>`r Sys.time()`</tt>

## Source code
File is at `r fnamepath`.

### R code used in this document
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

### Complete Rmd code
```{r comment=''}
cat(readLines(fnamepath), sep = '\n')
```
